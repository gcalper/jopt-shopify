{% assign block_settings = block.settings %}

<script
  src="{{ 'component-cart-items.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>
<script
  src="{{ 'component-cart-quantity-selector.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>
<script
  src="{{ 'product-form.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>
<script
  src="{{ 'variant-picker.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>

{%- comment -%} Global event handler for cart recommendation modals - loaded early {%- endcomment -%}
<script>
  (function() {
    // Only attach once
    if (window.cartRecGlobalHandlerAttached) {
      return;
    }
    window.cartRecGlobalHandlerAttached = true;
    
    // Global click handler for ANY cart rec modal
    document.addEventListener('click', async function(e) {
      const button = e.target.closest('button[data-cart-rec-submit]');
      if (!button) {
        return;
      }
      
      e.preventDefault();
      e.stopPropagation();
      
      // Find the dialog this button belongs to
      const modal = button.closest('dialog');
      
      if (!modal) {
        return;
      }
      
      // Initialize modal data if it doesn't exist (handles dynamic cart refreshes)
      if (!modal.__cartRecData) {
        const form = modal.querySelector('form[data-cart-rec-form]');
        const variantIdInput = form ? form.querySelector('input[data-variant-input]') : null;
        const variantPicker = modal.querySelector('.cart-rec-modal__variant-picker');
        
        if (!form || !variantIdInput || !variantPicker) {
          return;
        }
        
        const variantsData = JSON.parse(variantPicker.getAttribute('data-product-variants') || '[]');
        
        // Create the modal data object
        modal.__cartRecData = {
          variantIdInput: variantIdInput,
          variantsData: variantsData,
          productId: modal.dataset.productId,
          
          findVariantBySelectedOptions: function() {
            if (!variantsData || variantsData.length === 0) {
              return null;
            }
            
            // Get all selected option values in order
            const selectedOptions = [];
            const fieldsets = Array.from(modal.querySelectorAll('fieldset[data-option-position]')).sort((a, b) => {
              return parseInt(a.getAttribute('data-option-position')) - parseInt(b.getAttribute('data-option-position'));
            });
            
            fieldsets.forEach((fieldset) => {
              const checkedInput = fieldset.querySelector('input[type="radio"]:checked');
              if (checkedInput) {
                const value = checkedInput.value.trim();
                selectedOptions.push(value);
              }
            });
            
            // Find matching variant
            const variant = variantsData.find(v => {
              if (!v.options || v.options.length !== selectedOptions.length) return false;
              
              const match = v.options.every((option, index) => {
                const variantOption = String(option).trim();
                const selectedOption = String(selectedOptions[index]).trim();
                return variantOption === selectedOption;
              });
              
              return match;
            });
            
            return variant ? variant.id : null;
          },
          
          updateVariantId: function() {
            const variantId = this.findVariantBySelectedOptions();
            if (variantId && variantIdInput) {
              variantIdInput.value = variantId;
            }
            return variantId;
          }
        };
      }
      
      const modalData = modal.__cartRecData;
      
      // Update and get variant ID
      const variantId = modalData.updateVariantId();
      
      if (!variantId) {
        alert('選択されたオプションの組み合わせが見つかりません。');
        return;
      }
      
      // Disable button while processing
      button.disabled = true;
      button.textContent = '追加中...';
      
      try {
        // Submit to cart with proper headers - use .js endpoint for JSON response
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            id: variantId,
            quantity: 1
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Dispatch cart update event to trigger theme cart refresh
          const cartUpdateEvent = new CustomEvent('cart:update', {
            bubbles: true,
            detail: {
              resource: {},
              sourceId: modal.id,
              data: {
                source: 'product-form-component',
                itemCount: 1,
                productId: modalData.productId,
                variantId: variantId.toString()
              }
            }
          });
          document.dispatchEvent(cartUpdateEvent);
          
          // Close modal after a short delay
          setTimeout(() => {
            modal.close();
            button.disabled = false;
            button.textContent = '追加';
          }, 300);
        } else {
          alert(data.message || data.description || 'カートに追加できませんでした。');
          button.disabled = false;
          button.textContent = '追加';
        }
      } catch (error) {
        alert('エラーが発生しました。もう一度お試しください。');
        button.disabled = false;
        button.textContent = '追加';
      }
    });
  })();
</script>

<div
  {{ block.shopify_attributes }}
  class="cart-items__wrapper"
  {% if settings.product_title_case == 'uppercase' %}
    style="--product-title-case: uppercase;"
  {% endif %}
>
  {% if cart.empty? %}
    {%- if shop.customer_accounts_enabled and customer == null -%}
      <p>
        {{ 'actions.log_in_html' | t: link: routes.account_login_url }}
      </p>
    {%- endif -%}

    <a
      class="button cart-items__empty-button"
      href="{{ settings.empty_cart_button_link | default: routes.all_products_collection_url }}"
    >
      {{ 'actions.continue_shopping' | t }}
    </a>
  {%- else -%}
    <span
      class="visually-hidden"
      ref="cartItemCount"
      aria-hidden="true"
    >
      {{- cart.item_count -}}
    </span>
    <form
      action="{{ routes.cart_url }}"
      class="cart-form"
      id="cart-form"
      method="post"
    >
      <div
        class="cart-items spacing-style{% if block_settings.dividers %} cart-items--dividers{% endif %}"
        style="{%  render 'spacing-style', settings: block_settings %} --cart-items-gap:{{ block_settings.gap | append: "px" }};"
      >
        <table
          class="cart-items__table"
          role="table"
        >
          <caption
            class="visually-hidden"
            role="caption"
          >
            {{ 'content.cart_total' | t }}
            <span>{{ cart.total_price | money_with_currency }}</span>
          </caption>

          <thead
            class="visually-hidden"
            role="rowgroup"
          >
            <tr
              role="row"
              class="cart-items__table-row"
            >
              <th
                id="productImage"
                scope="col"
                role="columnheader"
              >
                {{ 'content.product_image' | t }}
              </th>
              <th
                id="productInformation"
                scope="col"
                role="columnheader"
              >
                {{ 'content.product_information' | t }}
              </th>
              <th
                id="quantity"
                scope="col"
                role="columnheader"
              >
                {{ 'content.quantity' | t }}
              </th>
              <th
                id="productTotal"
                scope="col"
                role="columnheader"
              >
                {{ 'content.product_total' | t }}
              </th>
            </tr>
          </thead>

          <tbody role="rowgroup">
            {% for item in cart.items %}
              <tr
                role="row"
                class="cart-items__table-row{% if item.parent_relationship.parent != null %} cart-items__nested-line{% endif %}"
                ref="cartItemRows[]"
                data-parent-key="{{ item.parent_relationship.parent.key }}"
                data-key="{{ item.key }}"
              >
                <td
                  class="cart-items__media"
                  role="cell"
                  headers="productImage"
                >
                  {% if item.image -%}
                    {% liquid
                      assign ratio = 1
                      assign border_opacity = settings.cart_thumbnail_border_opacity | divided_by: 100.0
                      assign border_override = '--border-width: [cart_thumbnail_border_width]px; --border-style: [cart_thumbnail_border_style]; --border-color: rgb(var(--color-border-rgb) / [cart_thumbnail_border_opacity]); --border-radius: [cart_thumbnail_border_radius]px;' | replace: '[cart_thumbnail_border_width]', settings.cart_thumbnail_border_width | replace: '[cart_thumbnail_border_style]', settings.cart_thumbnail_border | replace: '[cart_thumbnail_border_opacity]', border_opacity | replace: '[cart_thumbnail_border_radius]', settings.cart_thumbnail_border_radius

                      if settings.cart_thumbnail_border_radius > 0
                        assign border_override = border_override | append: ' overflow: hidden;'
                      endif
                      if block_settings.image_ratio == 'portrait'
                        assign ratio = 0.8
                      elsif block_settings.image_ratio == 'adapt'
                        assign ratio = item.image.aspect_ratio
                      endif
                    %}
                    <a
                      href="{{ item.url }}"
                      class="cart-items__media-container"
                      style="--ratio:{{ ratio }};"
                    >
                      {%- liquid
                        echo item.image | image_url: width: 250 | image_tag: class: 'cart-items__media-image border-style', style: border_override
                      -%}
                    </a>
                  {%- endif %}
                </td>
                <td
                  class="cart-items__details cart-primary-typography"
                  role="cell"
                  headers="productInformation"
                >
                  <p>
                    <a
                      href="{{ item.url }}"
                      class="cart-items__title"
                      {% if item.parent_relationship.parent != null %}
                        aria-label="{{ 'accessibility.nested_product' | t: product_title: item.product.title, parent_title: item.parent_relationship.parent.title | escape }}"
                      {% endif %}
                    >
                      {{- item.product.title -}}
                    </a>
                  </p>
                  {% if item.product.vendor and block_settings.vendor %}
                    <p>
                      {{ item.product.vendor }}
                    </p>
                  {% endif %}

                  {%- if item.item_components.size != 0 -%}
                    <ul class="cart-items__bundle list-unstyled">
                      {%- for component in item.item_components -%}
                        <li>
                          {{- component.title -}}
                          {%- if component.quantity > 1 -%}
                            <span> × {{ component.quantity }}</span>
                          {%- endif -%}
                        </li>
                      {%- endfor -%}
                    </ul>
                  {%- endif -%}

                  {%- if item.product.has_only_default_variant == false
                    or item.properties.size != 0
                    or item.selling_plan_allocation != null
                  -%}
                    <dl class="cart-items__variants">
                      {%- if item.product.has_only_default_variant == false and item.item_components.size == 0 -%}
                        {%- for option in item.options_with_values -%}
                          <div class="cart-items__variant">
                            <dt class="visually-hidden">{{ option.name }}:</dt>
                            <dd>
                              {{- option.value -}}
                              {%- if forloop.last != true %},&nbsp;{% endif -%}
                            </dd>
                          </div>
                        {%- endfor -%}
                      {%- endif -%}

                      {%- for property in item.properties -%}
                        {%- assign property_first_char = property.first | slice: 0 -%}
                        {%- if property.last != blank and property_first_char != '_' -%}
                          <div class="cart-items__properties">
                            <dt>{{ property.first }}:</dt>
                            <dd>
                              {%- if property.last contains '/uploads/' -%}
                                <a href="{{ property.last }}">{{ property.last | split: '/' | last }}</a>
                              {%- else -%}
                                {{ property.last }}
                              {%- endif -%}
                            </dd>
                          </div>
                        {%- endif -%}
                      {%- endfor -%}
                    </dl>

                    {% if item.selling_plan_allocation %}
                      <p>{{ item.selling_plan_allocation.selling_plan.name }}</p>
                    {% endif %}
                  {%- endif -%}

                  {% if item.line_level_discount_allocations.size > 0 %}
                    <ul
                      class="list-unstyled"
                      role="list"
                    >
                      {%- for discount in item.line_level_discount_allocations -%}
                        <li>{{ discount.discount_application.title | escape }}</li>
                      {%- endfor -%}
                    </ul>
                  {% endif %}

                  <div>
                    {% if item.original_price != item.final_price %}
                      <span class="visually-hidden">{{ 'content.price_sale' | t }}</span>
                      <span>{{ item.final_price | money }}</span>
                      <span class="visually-hidden">{{ 'content.price_regular' | t }}</span>
                      <s class="compare-at-price">
                        {% if item.variant.compare_at_price > item.original_price %}
                          {{ item.variant.compare_at_price | money }}
                        {% else %}
                          {{ item.original_price | money }}
                        {% endif %}
                      </s>
                    {% else %}
                      {% if item.variant.compare_at_price > item.original_price %}
                        <span class="visually-hidden">{{ 'content.price_sale' | t }}</span>
                      {% else %}
                        <span class="visually-hidden">{{ 'content.price' | t }}</span>
                      {% endif %}

                      <span>{{ item.original_price | money }}</span>

                      {% if item.variant.compare_at_price > item.original_price %}
                        <span class="visually-hidden">{{ 'content.price_regular' | t }}</span>
                        <s class="compare-at-price">{{ item.variant.compare_at_price | money }}</s>
                      {% endif %}
                    {% endif %}
                  </div>
                </td>
                <td
                  class="cart-items__quantity"
                  role="cell"
                  headers="quantity"
                >
                  {% # Here I want to pass some arguments to the quantity block so it knows which value should the input be set to. Though quantity block could be a snippet instead %}
                  {% assign can_update_quantity = item.instructions.can_update_quantity
                    | default: true, allow_false: true
                  %}
                  {% render 'quantity-selector',
                    product: item.product,
                    variant: item.variant,
                    in_cart_quantity: item.quantity,
                    line_index: item.index,
                    class: 'cart-primary-typography',
                    can_update_quantity: can_update_quantity
                  %}

                  <button
                    class="button button--tertiary cart-items__remove"
                    type="button"
                    aria-label="{{ 'accessibility.remove_item' | t: title: item.title | escape }}"
                    on:click="/onLineItemRemove/{{ item.index | plus: 1 }}"
                    {% assign can_remove = item.instructions.can_remove | default: true, allow_false: true %}
                    {% if can_remove == false %}
                      hidden
                    {% endif %}
                  >
                    {{- 'icon-delete.svg' | inline_asset_content -}}
                    <span class="visually-hidden">Remove</span>
                  </button>
                </td>
                <td
                  class="cart-items__error hidden"
                  role="cell"
                  ref="cartItemErrorContainer-{{ item.index | plus: 1 }}"
                  headers="quantity"
                >
                  <div
                    class="cart-item__error"
                    role="alert"
                  >
                    <span class="svg-wrapper">
                      {{- 'icon-error.svg' | inline_asset_content -}}
                    </span>
                    <small
                      class="cart-item__error-text cart-primary-typography"
                      ref="cartItemError-{{ item.index | plus: 1 }}"
                    ></small>
                  </div>
                </td>
                <td
                  class="cart-items__price cart-secondary-typography"
                  role="cell"
                  headers="productTotal"
                >
                  {%- liquid
                    if settings.currency_code_enabled_cart_items
                      assign price = item.final_line_price | money_with_currency
                      assign unit_price = item.unit_price | money_with_currency
                    else
                      assign price = item.final_line_price | money
                      assign unit_price = item.unit_price | money
                    endif
                  -%}
                  <text-component value="{{ price | strip_html }}">{{ price }}</text-component>
                  {%- if item.unit_price_measurement -%}
                    <div class="cart-items__price-unit cart-secondary-typography">
                      {% render 'unit-price', price: unit_price, measurement: item.unit_price_measurement %}
                    </div>
                  {%- endif -%}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
    
    {%- comment -%} Recommended Products Section - Only show in cart drawer, not on cart page {%- endcomment -%}
    {%- if template.name != 'cart' -%}
      <div class="cart-recommended">
        <h3 class="cart-recommended__title">こちらもいかがですか?</h3>
        
        {%- liquid
          # Create array of product IDs already in cart
          assign cart_product_ids = cart.items | map: 'product_id'
          
          # Build string of available product IDs not in cart
          assign available_product_ids = ''
          assign separator = '||'
          
          for product in collections.all.products limit: 50
            assign product_in_cart = false
            for cart_product_id in cart_product_ids
              if cart_product_id == product.id
                assign product_in_cart = true
                break
              endif
            endfor
            
            # Only include products that are not in cart AND have available stock
            if product_in_cart == false and product.available
              if available_product_ids == ''
                assign available_product_ids = product.id
              else
                assign available_product_ids = available_product_ids | append: separator | append: product.id
              endif
            endif
          endfor
          
          # Select random product from available products
          assign recommended_product = blank
          if available_product_ids != ''
            assign available_ids_array = available_product_ids | split: separator
            assign random_index = 'now' | date: '%s' | modulo: available_ids_array.size
            assign selected_product_id = available_ids_array[random_index] | plus: 0
            
            # Find the product with the selected ID
            for product in collections.all.products limit: 50
              if product.id == selected_product_id
                assign recommended_product = product
                break
              endif
            endfor
          endif
        -%}
        
        {%- if recommended_product -%}
          {%- assign has_multiple_options = false -%}
          {%- if recommended_product.has_only_default_variant == false -%}
            {%- assign has_multiple_options = true -%}
          {%- endif -%}
          
          <div class="cart-recommended__product">
            <a href="{{ recommended_product.url }}" class="cart-recommended__product-link">
              {%- if recommended_product.featured_image -%}
                <div class="cart-recommended__image">
                  {{- recommended_product.featured_image | image_url: width: 200 | image_tag: class: 'cart-recommended__image-img', loading: 'lazy' -}}
                </div>
              {%- endif -%}
              
              <div class="cart-recommended__details">
                <p class="cart-recommended__product-title">{{ recommended_product.title }}</p>
                <p class="cart-recommended__product-price">
                  {%- if recommended_product.compare_at_price > recommended_product.price -%}
                    <span class="cart-recommended__price-sale">{{ recommended_product.price | money }}</span>
                    <s class="cart-recommended__price-compare">{{ recommended_product.compare_at_price | money }}</s>
                  {%- else -%}
                    <span>{{ recommended_product.price | money }}</span>
                  {%- endif -%}
                </p>
              </div>
            </a>
          
            {%- if has_multiple_options -%}
              <button
                type="button"
                class="button button--primary cart-recommended__add-button"
                onclick="document.getElementById('cart-rec-modal-{{ recommended_product.id }}').showModal()"
              >
                追加
              </button>
            {%- else -%}
              <product-form-component 
                class="cart-recommended__form-wrapper" 
                on:submit="/handleSubmit"
                data-product-id="{{ recommended_product.id }}"
              >
                <div class="visually-hidden" role="status" ref="liveRegion" aria-live="polite" aria-atomic="true"></div>
                {%- form 'product', recommended_product, data-type: 'add-to-cart-form' -%}
                  <input type="hidden" name="id" ref="variantId" value="{{ recommended_product.selected_or_first_available_variant.id }}">
                  <input type="hidden" name="quantity" value="1">
                  <button
                    type="submit"
                    name="add"
                    class="button button--primary cart-recommended__add-button"
                  >
                    追加
                  </button>
                {%- endform -%}
              </product-form-component>
            {%- endif -%}
          </div>
          
          {%- if has_multiple_options -%}
            <dialog id="cart-rec-modal-{{ recommended_product.id }}" class="cart-rec-modal" data-product-id="{{ recommended_product.id }}">
              <div class="cart-rec-modal__content">
                <button
                  type="button"
                  class="cart-rec-modal__close"
                  onclick="this.closest('dialog').close()"
                  aria-label="閉じる"
                >
                  {{- 'icon-close.svg' | inline_asset_content -}}
                </button>
                
                <h3 class="cart-rec-modal__title">{{ recommended_product.title }}</h3>
                
                {%- liquid
                  assign modal_form_id = 'cart-rec-form-' | append: recommended_product.id
                -%}
                
                <div class="cart-rec-modal__form">
                  <div class="visually-hidden" role="status" aria-live="polite" aria-atomic="true"></div>
                  <form id="{{ modal_form_id }}" data-cart-rec-form>
                    <input type="hidden" name="id" value="{{ recommended_product.selected_or_first_available_variant.id }}" data-variant-input>
                    <input type="hidden" name="quantity" value="1">
                    
                    <div class="cart-rec-modal__variant-picker" data-product-variants='{{ recommended_product.variants | json }}'>
                      {%- for product_option in recommended_product.options_with_values -%}
                        <fieldset class="variant-option variant-option--buttons" data-option-position="{{ product_option.position }}">
                          <legend class="variant-option__legend">{{ product_option.name | escape }}</legend>
                          <div class="variant-option__buttons">
                            {%- for product_option_value in product_option.values -%}
                              <label class="variant-option__button-label">
                                <input
                                  type="radio"
                                  name="option{{ product_option.position }}"
                                  value="{{ product_option_value | escape }}"
                                  aria-label="{{ product_option_value.name }}"
                                  data-option-position="{{ product_option.position }}"
                                  data-option-value="{{ product_option_value | escape }}"
                                  form="{{ modal_form_id }}"
                                  {% if product_option_value.available == false %}
                                    disabled
                                  {% endif %}
                                  {% if product_option_value.selected %}
                                    checked
                                  {% endif %}
                                >
                                <span>{{ product_option_value | escape }}</span>
                              </label>
                            {%- endfor -%}
                          </div>
                        </fieldset>
                      {%- endfor -%}
                    </div>
                    
                    <button
                      type="button"
                      name="add"
                      class="button button--primary cart-rec-modal__add-button"
                      data-cart-rec-submit
                      data-modal-id="cart-rec-modal-{{ recommended_product.id }}"
                    >
                      追加
                    </button>
                  </form>
                </div>
              </div>
            </dialog>
            
            <script>
              // Use setTimeout to ensure the dialog element is in the DOM
              setTimeout(function() {
                const dialog = document.getElementById('cart-rec-modal-{{ recommended_product.id }}');
                
                if (!dialog) {
                  return;
                }
                
                const form = dialog.querySelector('form[data-cart-rec-form]');
                
                if (!form) {
                  return;
                }
                
                const variantIdInput = form.querySelector('input[data-variant-input]');
                const variantPicker = dialog.querySelector('.cart-rec-modal__variant-picker');
                
                if (!variantPicker) {
                  return;
                }
                
                const variantsData = JSON.parse(variantPicker.getAttribute('data-product-variants') || '[]');
                
                function findVariantBySelectedOptions() {
                  if (!variantsData || variantsData.length === 0) {
                    return null;
                  }
                  
                  // Get all selected option values in order
                  const selectedOptions = [];
                  const fieldsets = Array.from(dialog.querySelectorAll('fieldset[data-option-position]')).sort((a, b) => {
                    return parseInt(a.getAttribute('data-option-position')) - parseInt(b.getAttribute('data-option-position'));
                  });
                  
                  fieldsets.forEach((fieldset) => {
                    const checkedInput = fieldset.querySelector('input[type="radio"]:checked');
                    if (checkedInput) {
                      const value = checkedInput.value.trim();
                      selectedOptions.push(value);
                    }
                  });
                  
                  // Find matching variant with exact match
                  const variant = variantsData.find(v => {
                    if (!v.options || v.options.length !== selectedOptions.length) return false;
                    
                    const match = v.options.every((option, index) => {
                      const variantOption = String(option).trim();
                      const selectedOption = String(selectedOptions[index]).trim();
                      return variantOption === selectedOption;
                    });
                    
                    return match;
                  });
                  
                  return variant ? variant.id : null;
                }
                
                // Update variant ID
                function updateVariantId() {
                  const variantId = findVariantBySelectedOptions();
                  if (variantId && variantIdInput) {
                    variantIdInput.value = variantId;
                  }
                  return variantId;
                }
                
                // Update immediately when script runs
                updateVariantId();
                
                // Update on any option change
                dialog.addEventListener('change', function(e) {
                  if (e.target && e.target.type === 'radio' && e.target.name.startsWith('option')) {
                    updateVariantId();
                  }
                });
                
                // Store modal data for global handler
                dialog.__cartRecData = {
                  updateVariantId: updateVariantId,
                  variantIdInput: variantIdInput,
                  variantsData: variantsData,
                  findVariantBySelectedOptions: findVariantBySelectedOptions,
                  productId: '{{ recommended_product.id }}'
                };
              }, 100);
            </script>
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- endif -%}
  {%- endif -%}
</div>

{% stylesheet %}
  .cart-items {
    --cart-item-media-width-min: 2.5rem;
    --cart-item-media-width-max: 7.5rem;

    container-name: cart-items;
    container-type: inline-size;
    width: 100%;
  }

  .cart-items-disabled {
    pointer-events: none;
  }

  .cart-items__table {
    width: 100%;
  }

  .cart-items__table * {
    margin: 0;
  }

  .cart-items__table-row {
    --cart-item-price-width: 6rem;

    display: grid;
    grid-template-columns: clamp(2.5rem, 15cqi, 7.5rem) minmax(0, 1fr) minmax(var(--cart-item-price-width), auto);
    grid-template-areas:
      'media details price'
      'media quantity price'
      'media error error';
    column-gap: var(--gap-md);
    align-items: start;
    padding-bottom: var(--cart-items-gap);
    margin-bottom: var(--margin-lg);
  }

  .cart-items__table-row.cart-items__nested-line td:first-child {
    width: 60%;
    justify-self: right;
  }

  html:active-view-transition-type(page-navigation) .cart-items__table-row {
    /* stylelint-disable-next-line declaration-no-important */
    view-transition-name: none !important;
  }

  .cart-items__table-row.removing {
    overflow: hidden;
    animation: removeRow calc(var(--animation-speed) * 2) var(--animation-easing) forwards;
    animation-delay: var(--animation-speed);
  }

  @keyframes removeRow {
    0% {
      height: var(--row-height);
    }

    100% {
      opacity: 0;
      height: 0;
      padding-bottom: 0;
      margin-bottom: 0;
      border-color: transparent;
    }
  }

  .cart-items__table-row:last-child {
    padding-bottom: 0;
  }

  .cart-items--dividers .cart-items__table-row {
    border-bottom: 1px solid var(--color-border);
    margin-bottom: var(--cart-items-gap);
  }

  .cart-items--dividers .cart-items__table-row:has(+ .cart-items__nested-line) {
    border-bottom: none;
    margin-bottom: 0;
  }

  .cart-items--dividers .cart-items__table-row:last-child {
    border-block-end: none;
    padding-block-end: 0;
    margin-bottom: 0;
  }

  .cart-items__details {
    grid-area: details;
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
  }

  .cart-items__details > * + *,
  .cart-items__bundle li {
    margin-block-start: var(--margin-2xs);
  }

  .cart-items__details * {
    font-size: var(--cart-font-size--sm);
  }

  .cart-items__details a {
    text-decoration: none;
  }

  .cart-items__title {
    font-size: var(--cart-font-size--md);
    color: var(--color-foreground);
    text-transform: var(--product-title-case);
  }

  .cart-items__variant {
    display: inline-block;
  }

  .cart-items__quantity {
    grid-area: quantity;
    margin-block-start: var(--margin-xs);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: var(--gap-xs);
    width: fit-content;
  }

  .cart-items__quantity .quantity-selector {
    display: inline-flex;
    flex: 0 1 var(--quantity-selector-width);
    font-size: var(--cart-font-size--sm);
    height: auto;
  }

  .cart-items__remove {
    background-color: transparent;
    color: var(--color-foreground);
    width: var(--minimum-touch-target);
    height: var(--minimum-touch-target);
    justify-content: center;
    box-shadow: none;
    padding: 0;
  }

  .cart-items__media {
    grid-area: media;
    padding: 0;
  }

  .cart-items__price {
    grid-area: price;
    min-height: unset;
    min-width: var(--cart-item-price-width);
    text-align: end;
    display: block;
    font-size: var(--cart-font-size--md);
  }

  .cart-items__price-unit {
    font-size: var(--cart-font-size--xs);
  }

  .cart-items__media-container {
    display: flex;
    aspect-ratio: var(--ratio);
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .cart-items__media-image {
    aspect-ratio: inherit;
    object-fit: cover;
    object-position: center center;
    width: 100%;
    height: auto;
  }

  .cart-items__empty-button {
    margin-top: var(--margin-md);
    padding-inline: var(--padding-4xl);
    padding-block: var(--padding-lg);
  }

  /* Error message */
  .cart-items__error {
    display: flex;
    align-items: flex-start;
    width: 100%;
    grid-area: error;
    margin-block-start: var(--margin-xs);
    opacity: 1;
    overflow: hidden;
    transform: translateY(0);
    transition: opacity var(--drawer-animation-speed) var(--animation-easing),
      transform var(--drawer-animation-speed) var(--animation-easing);

    @starting-style {
      opacity: 0;
      transform: translateY(-0.5rem);
    }
  }

  .cart-item__error {
    display: flex;
    align-items: flex-start;
    width: 100%;
    font-size: var(--cart-font-size--sm);
    padding-block: var(--padding-2xs);
  }

  .cart-item__error .svg-wrapper {
    flex-shrink: 0;
    width: var(--icon-size-xs);
    height: var(--icon-size-xs);
    margin-inline: var(--margin-3xs) var(--margin-xs);
    margin-block-start: var(--margin-3xs);
  }

  @container cart-items (min-width: 720px) {
    .cart-items__table-row {
      --cart-item-price-width: 6rem;

      grid-template-columns: 7.5rem 1fr 1fr minmax(var(--cart-item-price-width), auto);
      grid-template-rows: min-content 1fr;
      grid-template-areas:
        'media details quantity price'
        'media details error error';
    }

    .cart-items__quantity,
    .cart-items__price {
      grid-area: initial;
    }

    .cart-items__quantity {
      margin-top: 0;
    }

    .cart-items__price {
      min-height: var(--minimum-touch-target);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
    }
  }

  .cart__original-total-container,
  .cart__total-container {
    display: flex;
    flex-direction: column;
  }

  .cart__total-container {
    row-gap: var(--gap-2xs);

    &:has(.cart__installments) {
      row-gap: var(--gap-xs);
    }
  }

  .cart__original-total-container:empty {
    display: none;
  }

  .cart__summary-totals {
    display: flex;
    flex-direction: column;
    gap: var(--gap-xl);
    width: 100%;
    border-block-start: none;

    &:has(> :first-child:not(.cart__original-total-container, .cart__total-container)) {
      padding-block-start: 0;
      border-block-start: none;
    }

    @media screen and (min-width: 750px) {
      padding-block-start: 0;
    }
  }

  .cart__original-total-container,
  .cart__original-total-container * {
    font-size: var(--cart-font-size--sm);
  }

  .cart__total {
    font-weight: var(--font-weight-bold);
  }

  .cart__total-label {
    font-size: var(--cart-font-size--sm);
  }

  .cart__total-value {
    font-size: var(--cart-font-size--2xl);
  }

  .cart-primary-typography {
    font-family: var(--cart-primary-font-family);
    font-style: var(--cart-primary-font-style);
    font-weight: var(--cart-primary-font-weight);
  }

  .cart-secondary-typography {
    font-family: var(--cart-secondary-font-family);
    font-style: var(--cart-secondary-font-style);
    font-weight: var(--cart-secondary-font-weight);
  }

  .cart__ctas {
    width: 100%;
    display: grid;
    gap: var(--checkout-button-gap);
    grid-auto-flow: row;
    grid-template-columns: 1fr;
  }

  .cart__additional-checkout-buttons {
    width: 100%;
  }

  .cart__ctas .cart__checkout-button {
    width: 100%;
    height: clamp(25px, var(--height-buy-buttons), 55px);
    padding-inline: var(--padding-4xl);
  }

  shopify-accelerated-checkout-cart {
    --shopify-accelerated-checkout-inline-alignment: center;
    --shopify-accelerated-checkout-button-border-radius: var(--style-border-radius-buttons-primary);
    --shopify-accelerated-checkout-row-gap: var(--checkout-button-gap, 10px);
  }

  .cart-note {
    width: 100%;
  }

  @starting-style {
    .cart-note[open-by-default-on-desktop][open-by-default-on-mobile] .details-content {
      block-size: auto;
      opacity: 1;
      overflow-y: visible;
    }
  }

  .cart-note__inner {
    padding-block: var(--padding-2xs) var(--padding-sm);
  }

  .cart-note__summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .cart-note__summary:hover {
    color: rgb(var(--color-foreground-rgb) / var(--opacity-subdued-text));
  }

  .cart-note__label {
    display: flex;
    align-items: flex-start;
    gap: var(--gap-2xs);
    font-size: var(--cart-font-size--sm);
  }

  .cart-note__instructions {
    color: var(--color-input-text);
    background-color: var(--color-input-background);
    border-width: var(--style-border-width-inputs);
    border-color: var(--color-input-border);
    transition: box-shadow var(--animation-speed) ease;
    box-shadow: var(--input-box-shadow);
    min-height: 5.5rem;
    min-width: 100%;
    max-width: 100%;
    font-size: var(--cart-font-size--sm);
    padding: max(4px, calc(var(--style-border-radius-inputs) * (1 - cos(45deg))));
  }

  .cart-note .svg-wrapper {
    height: var(--icon-size-sm);
    width: var(--icon-size-sm);
    margin: 0;
  }

  .cart-note .icon-plus {
    height: var(--icon-size-xs);
    width: var(--icon-size-xs);
  }

  /* Remove animation */
  .remove-icon-bottom,
  .remove-icon-top {
    transition: transform var(--animation-speed) var(--animation-easing);
  }

  .cart-items__remove:hover .remove-icon-top {
    transform: translate(calc(-1 * var(--icon-stroke-width)), var(--icon-stroke-width)) rotate(-15deg);
  }

  .cart-items__remove:is(:hover, :active) .remove-icon-bottom {
    transform: translateY(var(--icon-stroke-width));
  }

  .cart-items__table-row.removing .remove-icon-bottom {
    transform: translateY(0);
  }

  .cart-items__table-row.removing .remove-icon-top {
    animation: removeButtonClickedIconTop var(--animation-speed) var(--animation-easing) forwards;
  }

  @keyframes removeButtonClickedIconTop {
    50% {
      transform: translate(0, calc(-1 * var(--icon-stroke-width)));
    }

    100% {
      transform: translate(0, 0);
    }
  }

  .cart-items__properties {
    display: block;
    margin-block-start: var(--margin-2xs);
  }

  .cart-items__properties dt,
  .cart-items__properties dd {
    display: inline;
  }

  /* Recommended products section */
  .cart-recommended {
    margin-top: var(--margin-xl);
    padding-top: var(--padding-lg);
    border-top: 1px solid var(--color-border);
  }

  .cart-recommended__title {
    font-size: var(--cart-font-size--lg);
    font-weight: 700;
    color: var(--color-foreground);
    margin: 0 0 var(--margin-md) 0;
    text-align: left;
  }

  .cart-recommended__product {
    width: 100%;
    display: flex;
    align-items: center;
    gap: var(--gap-sm);
    padding: var(--padding-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--style-border-radius-buttons-primary);
    transition: border-color var(--animation-speed) ease, box-shadow var(--animation-speed) ease;
  }

  .cart-recommended__product:hover {
    border-color: rgb(var(--color-foreground-rgb) / 0.3);
    box-shadow: 0 2px 8px rgb(var(--color-foreground-rgb) / 0.1);
  }

  .cart-recommended__product-link {
    display: flex;
    gap: var(--gap-md);
    flex: 1;
    text-decoration: none;
    color: var(--color-foreground);
    min-width: 0;
  }

  .cart-recommended__image {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    border-radius: var(--style-border-radius-buttons-primary);
    overflow: hidden;
  }

  .cart-recommended__image-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .cart-recommended__details {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: var(--gap-2xs);
  }

  .cart-recommended__product-title {
    font-size: var(--cart-font-size--md);
    font-weight: var(--font-weight-medium);
    margin: 0;
    line-height: 1.3;
    text-transform: var(--product-title-case);
  }

  .cart-recommended__product-price {
    font-size: var(--cart-font-size--sm);
    font-weight: var(--font-weight-bold);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
  }

  .cart-recommended__price-sale {
    color: var(--color-sale);
  }

  .cart-recommended__price-compare {
    font-size: var(--cart-font-size--xs);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-50));
    font-weight: var(--font-weight-normal);
  }

  .cart-recommended__form-wrapper {
    display: contents;
  }

  .cart-recommended__form-wrapper form {
    display: contents;
  }

  .cart-recommended__add-button {
    height: auto !important;
    min-height: unset !important;
    max-height: unset !important;
    padding-inline: var(--padding-sm) !important;
    padding-block: calc(var(--padding-2xs) * 1.8) !important;
    font-size: var(--cart-font-size--xs) !important;
    line-height: 1.2 !important;
    border-radius: 20px !important;
    white-space: nowrap;
    min-width: fit-content;
    flex-shrink: 0;
  }

  .cart-recommended__add-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Cart Recommendation Modal */
  .cart-rec-modal {
    border: none;
    border-radius: var(--style-border-radius-buttons-primary);
    padding: 0;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 40px rgb(0 0 0 / 0.2);
  }

  .cart-rec-modal::backdrop {
    background-color: rgb(0 0 0 / 0.5);
  }

  .cart-rec-modal[open] {
    animation: modalFadeIn var(--animation-speed) ease-out;
  }

  @keyframes modalFadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .cart-rec-modal__content {
    padding: var(--padding-xl);
    position: relative;
  }

  .cart-rec-modal__close {
    position: absolute;
    top: var(--margin-sm);
    right: var(--margin-sm);
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--padding-2xs);
    width: var(--minimum-touch-target);
    height: var(--minimum-touch-target);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-foreground);
    transition: transform 0.15s ease;
    z-index: 1;
  }

  .cart-rec-modal__close:hover {
    transform: scale(1.1);
  }

  .cart-rec-modal__close:active {
    transform: scale(0.9);
  }

  .cart-rec-modal__title {
    font-size: var(--font-size--lg);
    font-weight: var(--font-weight-bold);
    margin: 0 var(--margin-2xl) var(--margin-lg) 0;
    color: var(--color-foreground);
  }

  .cart-rec-modal__form form {
    display: flex;
    flex-direction: column;
    gap: var(--gap-lg);
  }

  .cart-rec-modal__variant-picker {
    display: flex;
    flex-direction: column;
    gap: var(--gap-md);
  }

  .cart-rec-modal__variant-picker .variant-option {
    margin: 0;
  }

  .cart-rec-modal__variant-picker .variant-option__legend {
    font-size: var(--font-size--sm);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--margin-sm);
    color: var(--color-foreground);
  }

  .cart-rec-modal__variant-picker .variant-option__buttons {
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-xs);
  }

  .cart-rec-modal__variant-picker .variant-option__button-label {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--padding-xs) var(--padding-md);
    font-size: var(--font-size--sm);
    border: 1px solid var(--color-border);
    border-radius: var(--style-border-radius-buttons-primary);
    cursor: pointer;
    transition: all var(--animation-speed) ease;
    background-color: var(--color-background);
  }

  .cart-rec-modal__variant-picker .variant-option__button-label:hover {
    border-color: var(--color-foreground);
  }

  .cart-rec-modal__variant-picker input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .cart-rec-modal__variant-picker input[type="radio"]:checked + span {
    font-weight: var(--font-weight-bold);
  }

  .cart-rec-modal__variant-picker .variant-option__button-label:has(input[type="radio"]:checked) {
    border-color: var(--color-foreground);
    background-color: var(--color-foreground);
    color: var(--color-background);
  }

  .cart-rec-modal__variant-picker .variant-option__button-label:has(input[type="radio"]:disabled) {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .cart-rec-modal__add-button {
    width: 100%;
    height: auto !important;
    min-height: unset !important;
    max-height: unset !important;
    padding-inline: var(--padding-sm) !important;
    padding-block: calc(var(--padding-2xs) * 2) !important;
    font-size: var(--cart-font-size--xs) !important;
    line-height: 1.2 !important;
    border-radius: 20px !important;
  }
{% endstylesheet %}
